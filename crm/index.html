<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Atlantis City</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- CRM Styles -->
    <link rel="stylesheet" href="crm.css">
    
    <style>
        /* === LOGIN SCREEN === */
        .crm-login-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .crm-login-box {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5);
        }
        
        .crm-login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .crm-login-logo {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin: 0 auto 20px;
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.4);
        }
        
        .crm-login-header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 8px;
        }
        
        .crm-login-header p {
            color: #64748b;
            font-size: 14px;
        }
        
        .crm-login-form .form-group {
            margin-bottom: 20px;
        }
        
        .crm-login-form .form-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #94a3b8;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .crm-login-form .form-input {
            width: 100%;
            padding: 14px 16px;
            font-size: 15px;
            color: #f1f5f9;
            background: #334155;
            border: 1px solid #475569;
            border-radius: 10px;
            transition: all 0.2s ease;
        }
        
        .crm-login-form .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        .crm-login-form .btn-login {
            width: 100%;
            padding: 16px;
            font-size: 15px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 10px;
        }
        
        .crm-login-form .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
        }
        
        .crm-login-form .btn-login:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .crm-login-message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }
        
        .crm-login-message.error {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
            display: block;
        }
        
        .crm-login-message.success {
            background: rgba(34, 197, 94, 0.15);
            color: #6ee7b7;
            border: 1px solid rgba(34, 197, 94, 0.3);
            display: block;
        }
        
        /* Hide CRM when not logged in */
        body.not-logged-in .crm-container {
            display: none;
        }
        
        body.logged-in .crm-login-screen {
            display: none;
        }
        
        /* Loading state */
        body.loading .crm-login-screen,
        body.loading .crm-container {
            display: none;
        }
        
        body.loading::before {
            content: '';
            position: fixed;
            inset: 0;
            background: #0f172a;
            z-index: 9999;
        }
        
        body.loading::after {
            content: '‚ö° Chargement...';
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #3b82f6;
            font-size: 18px;
            font-family: 'Inter', sans-serif;
            z-index: 10000;
        }
    </style>
</head>
<body class="loading">

<!-- === LOGIN SCREEN === -->
<div class="crm-login-screen">
    <div class="crm-login-box">
        <div class="crm-login-header">
            <div class="crm-login-logo">‚ö°</div>
            <h1>Atlantis City</h1>
            <p>Administration CRM</p>
        </div>
        
        <div id="login-message" class="crm-login-message"></div>
        
        <form class="crm-login-form" id="login-form" onsubmit="return handleLogin(event)">
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="login-email" required placeholder="admin@example.com">
            </div>
            <div class="form-group">
                <label class="form-label">Mot de passe</label>
                <input type="password" class="form-input" id="login-password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button type="submit" class="btn-login" id="login-btn">
                üîê Se connecter
            </button>
        </form>
    </div>
</div>

<!-- === CRM CONTAINER === -->
<div class="crm-container">
    <!-- === SIDEBAR === -->
    <aside class="crm-sidebar">
        <div class="crm-sidebar-header">
            <div class="crm-logo">‚ö°</div>
            <div class="crm-brand">
                <h1>Atlantis City</h1>
                <span>CRM Admin</span>
            </div>
        </div>

        <nav class="crm-nav">
            <div class="crm-nav-section">
                <div class="crm-nav-title">Principal</div>
                <div class="crm-nav-item active" data-section="dashboard">
                    <span class="icon">üìä</span>
                    <span>Dashboard</span>
                </div>
            </div>

            <div class="crm-nav-section">
                <div class="crm-nav-title">Gestion</div>
                <div class="crm-nav-item" data-section="users">
                    <span class="icon">üë•</span>
                    <span>Utilisateurs</span>
                    <span class="badge" id="pending-badge" style="display:none;">0</span>
                </div>
                <div class="crm-nav-item" data-section="spaces">
                    <span class="icon">üì¶</span>
                    <span>Espaces</span>
                </div>
                <div class="crm-nav-item" data-section="zones">
                    <span class="icon">üìç</span>
                    <span>Zones</span>
                </div>
                <div class="crm-nav-item" data-section="roles">
                    <span class="icon">üé≠</span>
                    <span>R√¥les</span>
                </div>
                <div class="crm-nav-item" data-section="contents">
                    <span class="icon">üñºÔ∏è</span>
                    <span>Contenus</span>
                </div>
            </div>

            <div class="crm-nav-section">
                <div class="crm-nav-title">Syst√®me</div>
                <div class="crm-nav-item" data-section="logs">
                    <span class="icon">üìù</span>
                    <span>Journal</span>
                </div>
            </div>
        </nav>

        <div class="crm-sidebar-footer">
            <div class="crm-user-avatar" id="sidebar-avatar">--</div>
            <div class="crm-user-info">
                <div class="crm-user-name" id="sidebar-name">Chargement...</div>
                <div class="crm-user-role" id="sidebar-role">Super Admin</div>
            </div>
            <button class="crm-logout-btn" onclick="window.CRM.logout()" title="D√©connexion">
                üö™
            </button>
        </div>
    </aside>

    <!-- === MAIN CONTENT === -->
    <main class="crm-main">
        <!-- Header -->
        <header class="crm-header">
            <div class="crm-page-title">
                <span class="icon">üìä</span>
                <h2>Dashboard</h2>
            </div>
            <div class="crm-header-actions">
                <span id="header-user-info" style="color: var(--text-muted); font-size: 14px;"></span>
            </div>
        </header>

        <!-- Content Area -->
        <div class="crm-content">
            <!-- Dashboard Section -->
            <section class="crm-section active" id="section-dashboard">
                <div class="crm-section-content">
                    <div class="crm-loading"><div class="crm-spinner"></div></div>
                </div>
            </section>

            <!-- Users Section -->
            <section class="crm-section" id="section-users">
                <div class="crm-section-content">
                    <div class="crm-loading"><div class="crm-spinner"></div></div>
                </div>
            </section>

            <!-- Spaces Section -->
            <section class="crm-section" id="section-spaces">
                <div class="crm-section-content">
                    <div class="crm-loading"><div class="crm-spinner"></div></div>
                </div>
            </section>

            <!-- Zones Section -->
            <section class="crm-section" id="section-zones">
                <div class="crm-section-content">
                    <div class="crm-loading"><div class="crm-spinner"></div></div>
                </div>
            </section>

            <!-- Roles Section -->
            <section class="crm-section" id="section-roles">
                <div class="crm-section-content">
                    <div class="crm-loading"><div class="crm-spinner"></div></div>
                </div>
            </section>

            <!-- Contents Section -->
            <section class="crm-section" id="section-contents">
                <div class="crm-section-content">
                    <div class="crm-loading"><div class="crm-spinner"></div></div>
                </div>
            </section>

            <!-- Logs Section -->
            <section class="crm-section" id="section-logs">
                <div class="crm-section-content">
                    <div class="crm-loading"><div class="crm-spinner"></div></div>
                </div>
            </section>
        </div>
    </main>
</div>

<!-- === LOGIN SCRIPT (avant crm.js) === -->
<script>
    const API_BASE = 'https://compagnon.atlantis-city.com/api';
    const TOKEN_KEY = 'atlantis_auth_token';
    const USER_KEY = 'atlantis_auth_user';

    // Afficher message login
    function showLoginMessage(text, type) {
        const el = document.getElementById('login-message');
        el.textContent = text;
        el.className = `crm-login-message ${type}`;
    }

    // G√©rer le login
    async function handleLogin(e) {
        e.preventDefault();
        
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value;
        const btn = document.getElementById('login-btn');

        btn.disabled = true;
        btn.textContent = '‚è≥ Connexion...';

        try {
            const response = await fetch(`${API_BASE}/auth/login.php`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            const result = await response.json();
            console.log('Login response:', result);

            if (result.success) {
                // Extraire token et user (supporte les deux formats)
                const token = result.data?.token || result.token;
                const user = result.data?.user || result.user;

                if (!token || !user) {
                    showLoginMessage('Erreur: r√©ponse serveur invalide', 'error');
                    btn.disabled = false;
                    btn.textContent = 'üîê Se connecter';
                    return;
                }

                // V√©rifier que c'est un super_admin
                if (user.global_role !== 'super_admin') {
                    showLoginMessage('Acc√®s refus√©. Vous devez √™tre Super Admin.', 'error');
                    btn.disabled = false;
                    btn.textContent = 'üîê Se connecter';
                    return;
                }

                // Sauvegarder
                localStorage.setItem(TOKEN_KEY, token);
                localStorage.setItem(USER_KEY, JSON.stringify(user));

                showLoginMessage('‚úÖ Connexion r√©ussie !', 'success');

                // Lancer le CRM
                setTimeout(() => {
                    document.body.classList.remove('not-logged-in');
                    document.body.classList.add('logged-in');
                    if (window.CRM && window.CRM.init) {
                        window.CRM.init();
                    }
                }, 500);

            } else {
                showLoginMessage(result.error || 'Email ou mot de passe incorrect', 'error');
                btn.disabled = false;
                btn.textContent = 'üîê Se connecter';
            }
        } catch (error) {
            console.error('Login error:', error);
            showLoginMessage('Erreur de connexion au serveur', 'error');
            btn.disabled = false;
            btn.textContent = 'üîê Se connecter';
        }

        return false;
    }

    // V√©rifier auth au chargement
    function checkInitialAuth() {
        const token = localStorage.getItem(TOKEN_KEY);
        const userStr = localStorage.getItem(USER_KEY);

        if (token && userStr) {
            try {
                const user = JSON.parse(userStr);
                if (user.global_role === 'super_admin') {
                    // D√©j√† connect√© en super_admin
                    document.body.classList.remove('loading', 'not-logged-in');
                    document.body.classList.add('logged-in');
                    return true;
                }
            } catch (e) {
                console.error('Error parsing stored user:', e);
            }
        }

        // Pas connect√© ou pas super_admin
        document.body.classList.remove('loading', 'logged-in');
        document.body.classList.add('not-logged-in');
        return false;
    }

    // Init au chargement DOM
    document.addEventListener('DOMContentLoaded', () => {
        const isLoggedIn = checkInitialAuth();
        
        if (isLoggedIn) {
            // Le CRM.init() sera appel√© par crm.js
        }
    });
</script>

<!-- CRM Script -->
<script src="crm.js"></script>

</body>
</html>